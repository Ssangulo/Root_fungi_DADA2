#### FIX CONTAM SEQS

# Running top 15 OTUs by reads in PLutoF (SH matching) showed that 6 of these are Ericaceae DNA


ps <- alldat.N[[2]]
# extract OTU matrix
otu_mat <- as(otu_table(ps), "matrix")
if (!taxa_are_rows(ps)) otu_mat <- t(otu_mat)

# total reads per OTU
otu_totals <- rowSums(otu_mat)

# top 15 OTUs
top15_otus <- data.frame(
  OTU_ID = names(otu_totals),
  total_reads = as.numeric(otu_totals)
) %>%
  arrange(desc(total_reads)) %>%
  slice(1:15)

top15_otus

#Extracting FASTA file
# 1) Extract OTU abundance matrix
otu_mat <- as(otu_table(ps), "matrix")
if (!taxa_are_rows(ps)) otu_mat <- t(otu_mat)

# 2) Identify top 15 OTUs by total reads
otu_totals <- rowSums(otu_mat)

top15_ids <- names(sort(otu_totals, decreasing = TRUE))[1:15]
top15_ids
top15_seqs <- refseq(ps)[top15_ids]
top15_seqs

writeXStringSet(
  top15_seqs,
  filepath = "top15_OTUs_refseqs.fasta",
  format = "fasta"
)



##### DEFINE CONTAMINANT OTUS AND QUANIFY CONTAMINATION
host_otus <- c("OTU1", "OTU13615", "OTU14390", "OTU15169", "OTU15933", "OTU2310")

otu_mat <- as(otu_table(ps), "matrix")
if (!taxa_are_rows(ps)) otu_mat <- t(otu_mat)

total_reads_all <- sum(otu_mat)
total_reads_all

host_reads <- sum(otu_mat[host_otus, , drop = FALSE])
host_reads

pct_host_reads <- 100 * host_reads / total_reads_all
pct_host_reads

ps_fungi <- prune_taxa(!taxa_names(ps) %in% host_otus, ps)

tree_ps <- prune_taxa(!taxa_names(tree) %in% host_otus, tree)

##RERUNNING KEY ANALYSES

ps <- ps_fungi

new_metadata <- read.csv("/data/lastexpansion/danieang/data/trimmed/mergedPlates/fix_metadata.csv",
                         row.names = 1)
sample_data(ps) <- sample_data(new_metadata)

# 1) OTU table as SAMPLES x TAXA (rows = samples, cols = OTUs)
otu_table_data <- otu_table(ps)
if (taxa_are_rows(ps)) otu_table_data <- t(otu_table_data)

# 2) Data frames
otu_table_df <- as.data.frame(otu_table_data, check.names = FALSE)
otu_table_df$SampleID <- rownames(otu_table_df)

sample_data_df <- data.frame(sample_data(ps), check.names = FALSE)
sample_data_df$SampleID <- rownames(sample_data_df)

# 3) Merge and remember which columns are OTUs
otu_cols <- setdiff(colnames(otu_table_df), "SampleID")

combined_df <- merge(
  otu_table_df,
  sample_data_df,
  by = "SampleID",
  all.x = TRUE
)

# be safe: OTU columns numeric
combined_df[otu_cols] <- lapply(combined_df[otu_cols], function(x) as.numeric(as.character(x)))

# 4) Sum OTUs by Unique_ID
summed_df <- combined_df |>
  dplyr::group_by(Unique_ID) |>
  dplyr::summarise(dplyr::across(dplyr::all_of(otu_cols), ~ sum(.x, na.rm = TRUE)),
                   .groups = "drop")

# 5) Keep ONE metadata row per Unique_ID, **excluding OTU columns**
first_sample_ids <- combined_df |>
  dplyr::group_by(Unique_ID) |>
  dplyr::summarise(dplyr::across(-dplyr::all_of(otu_cols), ~ dplyr::first(.x)),
                   .groups = "drop")

# 6) Join metadata + summed OTUs
final_df <- dplyr::left_join(first_sample_ids, summed_df, by = "Unique_ID")

# 7) Build matrices/metadata for phyloseq
otu_summed <- final_df |>
  dplyr::select(dplyr::all_of(otu_cols)) |>
  as.matrix()

# use Unique_ID as the collapsed sample name
rownames(otu_summed) <- final_df$Unique_ID

sample_metadata <- final_df |>
  dplyr::select(Unique_ID, site, site_elevation, habitat, treeline, Individual,
                elevation, elevation_adj) |>
  as.data.frame()

rownames(sample_metadata) <- sample_metadata$Unique_ID
sample_metadata$Unique_ID <- NULL

# 8) Make phyloseq (reuse taxonomy from ps if present)
otu_ps <- otu_table(otu_summed, taxa_are_rows = FALSE)
sample_ps <- sample_data(sample_metadata)

if (!is.null(tax_table(ps, errorIfNULL = FALSE))) {
  individual_ps <- phyloseq(otu_ps, sample_ps, tax_table(ps))
} else {
  individual_ps <- phyloseq(otu_ps, sample_ps)
}

# drop zero-sum taxa (optional, same as you did elsewhere)
individual_ps <- prune_taxa(taxa_sums(individual_ps) > 0, individual_ps)


individual_ps

###PERMANOVA
balanced_ps <- subset_samples(individual_ps, site %in% c("DOM", "NV"))
balanced_ps <- subset_samples(balanced_ps, !(site_elevation == "NV_4"))
balanced_ps <- prune_taxa(taxa_sums(balanced_ps) > 0, balanced_ps)  # Prune taxa with zero abundance


dists <- vegdist(otu_table(balanced_ps), binary=FALSE, method="robust.aitchison") 
sampledf <- data.frame(sample_data(balanced_ps))
#sampledf$elevation_adj <- factor(sampledf$elevation_adj) # Convert elevation_adj to a factor

#adonis2(dists ~ elevation_adj, data = sampledf)
adonis2(dists ~ site * habitat, by = "terms", data = sampledf)


beta <- betadisper(dists, sampledf$habitat)
beta1 <- betadisper(dists, sampledf$site)

permutest(beta)
permutest(beta1)

##### VERY SIMILAR - GREAT

## beta_regression does change significatively - changing those. 


### Trying with iNEXT and NTI... 
# New NTI

ps <- ps_fungi

#some quick summaries
sum(otu_table(alldat.N[[2]]))
sum(otu_table(alldat[[1]]))
sum(otu_table(ps_fungi))


x <- sample_sums(ps_fungi)
c(mean = mean(x), SE = sd(x) / sqrt(length(x)))

x <- sample_sums(alldat.N[[2]])
c(mean = mean(x), SD = sd(x))


