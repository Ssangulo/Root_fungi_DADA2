
library(phyloseq)
library(dplyr)




#code to summarize OTU counts from same individual...

#MOOVING TO BETA REGRESION
# Convert the OTU table to a matrix and transpose so that OTUs are rows and samples are columns

ps <- individual_ps

# 1) OTU matrix with taxa as rows
otu <- as(otu_table(ps), "matrix")
if (!taxa_are_rows(ps)) otu <- t(otu)  # rows = taxa, cols = samples

# 2) Robust Helotiales filter from taxonomy
tax <- as.data.frame(tax_table(ps), stringsAsFactors = FALSE)
helotiales_otus <- rownames(tax)[grepl("helotiales", tolower(tax$Order %||% ""))]

# 3) Counts per sample
helot_counts <- colSums(otu[helotiales_otus, , drop = FALSE])
total_counts <- colSums(otu)

# 4) Build dataframe aligned to column order of `otu`
sdat <- as.data.frame(sample_data(ps))
samples <- colnames(otu)

df <- data.frame(
  SampleID = samples,
  HelotialesCount = helot_counts[samples],
  TotalCount = total_counts[samples],
  Site = sdat[samples, "site", drop = TRUE],
  Elevation = sdat[samples, "elevation", drop = TRUE],
  stringsAsFactors = FALSE
)

# 5) Proportion + Smithson–Verkuilen adjustment to keep in (0,1)
df$Proportion <- with(df, HelotialesCount / pmax(TotalCount, 1))
n <- nrow(df)
df$Proportion <- (df$Proportion * (n - 1) + 0.5) / n

# 6) Beta regression
library(betareg)
model_helotiales_old <- betareg(Proportion ~ elevation + site, data = df)

summary(model_helot_beta)
summary(model_helot_beta_noMA)
summary(model_helot_root)

summary(model_sebac_beta)
summary(model_sebac_beta_noMA)
summary(model_sebac_root)


#Diagnostic plots

plot_betareg_diagnostics <- function(model, data, label_prefix = "Helotiales") {
  # residuals & fitted
  res_pear <- residuals(model, type = "pearson")
  res_quant <- residuals(model, type = "quantile")   # approx N(0,1)
  fit <- fitted(model)
  hatv <- hatvalues(model)
  
  # robust column names for elevation/site
  elev_col <- if ("elevation" %in% names(data)) "elevation" else "Elevation"
  site_col <- if ("site" %in% names(data)) "site" else "Site"
  
  diagdf <- data.frame(
    fitted    = fit,
    res_pear  = res_pear,
    res_quant = res_quant,
    elevation = data[[elev_col]],
    site      = as.factor(data[[site_col]]),
    hat       = hatv,
    idx       = seq_len(nrow(data))
  )
  
  # (1) Residuals vs Fitted
  p1 <- ggplot(diagdf, aes(fitted, res_pear)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "grey40") +
    geom_point(alpha = 0.7, size = 1.8) +
    geom_smooth(method = "loess", se = FALSE, linewidth = 0.5) +
    labs(x = "Fitted values", y = "Pearson residuals",
         title = paste(label_prefix, "- Residuals vs Fitted")) +
    theme_bw(base_size = 9)
  
  # (2) Residuals vs Elevation
  p2 <- ggplot(diagdf, aes(elevation, res_pear)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "grey40") +
    geom_point(alpha = 0.7, size = 1.8) +
    geom_smooth(method = "loess", se = FALSE, linewidth = 0.5) +
    labs(x = "Elevation (m)", y = "Pearson residuals",
         title = paste(label_prefix, "- Residuals vs Elevation")) +
    theme_bw(base_size = 9)
  
  # (3) Q–Q plot of quantile residuals (should be ~N(0,1))
  p3 <- ggplot(diagdf, aes(sample = res_quant)) +
    stat_qq(size = 1.4, alpha = 0.8) +
    stat_qq_line() +
    labs(title = paste(label_prefix, "- Q–Q Plot (quantile residuals)"),
         x = "Theoretical quantiles", y = "Sample quantiles") +
    theme_bw(base_size = 9)
  
  # (4) Leverage
  hat_thr <- 2 * mean(diagdf$hat, na.rm = TRUE)
  p4 <- ggplot(diagdf, aes(idx, hat)) +
    geom_point(alpha = 0.85, size = 1.8) +
    geom_hline(yintercept = hat_thr, color = "red", linetype = "dashed") +
    labs(x = "Observation index", y = "Leverage (hat values)",
         title = paste(label_prefix, "- Leverage (red = threshold)")) +
    theme_bw(base_size = 9)
  
  (p1 | p2) / (p3 | p4) +
    plot_annotation(title = paste(label_prefix, "Model Diagnostics")) &
    theme(plot.title = element_text(face = "bold", size = 10, hjust = 0))
}

# --- Run & save ---
diag_helot <- plot_betareg_diagnostics(model_helotiales, df, "Helotiales")
diag_seba  <- plot_betareg_diagnostics(model_sebacinales, df, "Sebacinales")

ggsave("/data/lastexpansion/danieang/Plots2/Helotiales_betareg_diagnostics.png",
       plot = diag_helot, width = 8.5, height = 6.5, dpi = 600)
ggsave("/data/lastexpansion/danieang/Plots2/Sebacinales_betareg_diagnostics.png",
       plot = diag_seba, width = 8.5, height = 6.5, dpi = 600)


#####
## Beta regression plots with raw data making sure not mixing dataframes robust code:

# 1) OTU matrix with taxa as rows
otu <- as(otu_table(ps), "matrix")
if (!taxa_are_rows(ps)) {
  otu <- t(otu)  # rows = taxa, cols = samples
}

# 2) Taxonomy and robust taxon filters
tax <- as.data.frame(tax_table(ps), stringsAsFactors = FALSE)

order_vec <- if ("Order" %in% names(tax)) tax$Order else NA_character_

helotiales_otus <- rownames(tax)[grepl("helotiales", tolower(order_vec))]
sebacinales_otus <- rownames(tax)[grepl("sebacinales", tolower(order_vec))]

# 3) Counts per sample
total_counts      <- colSums(otu)
helot_counts      <- colSums(otu[helotiales_otus, , drop = FALSE])
sebacinales_counts <- colSums(otu[sebacinales_otus, , drop = FALSE])

# 4) Sample data aligned to `otu` columns
sdat    <- as.data.frame(sample_data(ps))
samples <- colnames(otu)

# Helper to build a clean beta-regression data.frame
make_beta_df <- function(counts_vec, total_vec, sdat, samples) {
  df <- data.frame(
    sample    = samples,
    count     = counts_vec[samples],
    total     = total_vec[samples],
    site      = sdat[samples, "site",      drop = TRUE],
    elevation = sdat[samples, "elevation", drop = TRUE],
    stringsAsFactors = FALSE
  )
  
  # raw proportion
  df$prop_raw <- ifelse(df$total > 0, df$count / df$total, NA_real_)
  
  # Smithson–Verkuilen adjustment -> (0,1)
  n <- nrow(df)
  df$Proportion <- (df$prop_raw * (n - 1) + 0.5) / n
  
  # Ensure proper types
  df$site      <- factor(df$site)
  df$elevation <- as.numeric(df$elevation)
  
  df
}

df_helot <- make_beta_df(helot_counts,      total_counts, sdat, samples)
df_seba  <- make_beta_df(sebacinales_counts, total_counts, sdat, samples)

# Helotiales beta regression
model_helotiales <- betareg(Proportion ~ elevation + site, data = df_helot)

# Sebacinales beta regression
model_sebacinales <- betareg(Proportion ~ elevation + site, data = df_seba)

# inverse logit helper
inv_logit <- function(x) 1 / (1 + exp(-x))

plot_betareg_with_raw <- function(model, data, label_prefix = "Helotiales") {
  # --- Column name harmonization
  elev_col <- if ("elevation" %in% names(data)) "elevation" else "Elevation"
  site_col <- if ("site" %in% names(data)) "site" else "Site"
  
  # --- Response column (prefer raw if present)
  prop_col <- if ("prop_raw" %in% names(data)) {
    "prop_raw"
  } else if ("Proportion" %in% names(data)) {
    "Proportion"
  } else if (all(c("count", "total") %in% names(data))) {
    data$prop_raw <- ifelse(data$total > 0, data$count / data$total, NA_real_)
    "prop_raw"
  } else {
    stop("No response column found (need prop_raw or Proportion).")
  }
  
  # --- Generate new data grid across observed elevation range for each site
  newdat <- data %>%
    dplyr::select(all_of(c(site_col, elev_col))) %>%
    distinct() %>%
    group_by(.data[[site_col]]) %>%
    summarize(
      elev_min = min(.data[[elev_col]], na.rm = TRUE),
      elev_max = max(.data[[elev_col]], na.rm = TRUE),
      .groups = "drop"
    ) %>%
    rowwise() %>%
    mutate(elev_seq = list(seq(elev_min, elev_max, length.out = 100))) %>%
    unnest(elev_seq) %>%
    rename(!!elev_col := elev_seq) %>%
    dplyr::select(all_of(c(site_col, elev_col))) %>%
    ungroup()
  
  # Ensure factor levels match model
  if (!is.null(model$xlevels$mean[[site_col]])) {
    newdat[[site_col]] <- factor(
      newdat[[site_col]],
      levels = model$xlevels$mean[[site_col]]
    )
  } else {
    newdat[[site_col]] <- factor(newdat[[site_col]])
  }
  
  # --- Build design matrix (mean submodel only)
  mean_terms <- stats::delete.response(stats::terms(model, model = "mean"))
  X <- model.matrix(mean_terms, newdat)
  
  beta <- coef(model, model = "mean")
  V    <- try(vcov(model, model = "mean"), silent = TRUE)
  if (inherits(V, "try-error")) V <- vcov(model)
  
  # Predict link-scale and transform to response with 95% CI
  eta    <- as.vector(X %*% beta)
  se_eta <- sqrt(rowSums((X %*% V) * X))
  
  newdat$fit <- inv_logit(eta)
  newdat$lwr <- inv_logit(eta - 1.96 * se_eta)
  newdat$upr <- inv_logit(eta + 1.96 * se_eta)
  
  # --- Plot raw data + model fit + CI ribbon
  ggplot() +
    geom_point(
      data = data,
      aes(
        x = .data[[elev_col]],
        y = .data[[prop_col]],
        colour = .data[[site_col]]
      ),
      size = 2, alpha = 0.7, na.rm = TRUE
    ) +
    geom_ribbon(
      data = newdat,
      mapping = aes(
        x     = .data[[elev_col]],
        ymin  = lwr,
        ymax  = upr,
        fill  = .data[[site_col]],
        group = .data[[site_col]]
      ),
      alpha = 0.15, colour = NA,
      inherit.aes = FALSE
    ) +
    geom_line(
      data = newdat,
      mapping = aes(
        x     = .data[[elev_col]],
        y     = fit,
        colour = .data[[site_col]],
        group = .data[[site_col]]
      ),
      linewidth = 0.8,
      inherit.aes = FALSE
    ) +
    scale_y_continuous("Proportion (raw)", limits = c(0, 1)) +
    scale_x_continuous("Elevation (m)") +
    ggtitle(paste0(label_prefix, " – beta regression fit with raw data")) +
    theme_bw(base_size = 10) +
    theme(
      legend.position = "right",
      plot.title      = element_text(face = "bold", size = 12, hjust = 0)
    )
}

p_helot <- plot_betareg_with_raw(model_helotiales,  df_helot, "Helotiales")
p_seba  <- plot_betareg_with_raw(model_sebacinales, df_seba,  "Sebacinales")

ggsave("/data/lastexpansion/danieang/Plots2/Helotiales_beta_with_raw.png",
       plot = p_helot, width = 7.2, height = 5.2, dpi = 600)
ggsave("/data/lastexpansion/danieang/Plots2/Sebacinales_beta_with_raw.png",
       plot = p_seba, width = 7.2, height = 5.2, dpi = 600)



######
## Beta regression plots with raw data 


# inverse logit helper
inv_logit <- function(x) 1 / (1 + exp(-x))

plot_betareg_with_raw <- function(model, data, label_prefix = "Helotiales") {
  # --- Column name harmonization
  elev_col <- if ("elevation" %in% names(data)) "elevation" else "Elevation"
  site_col <- if ("site" %in% names(data)) "site" else "Site"
  
  # --- Response column (prefer raw if present)
  prop_col <- if ("prop_raw" %in% names(data)) {
    "prop_raw"
  } else if ("Proportion" %in% names(data)) {
    "Proportion"
  } else if (all(c("count", "total") %in% names(data))) {
    data$prop_raw <- ifelse(data$total > 0, data$count / data$total, NA_real_)
    "prop_raw"
  } else {
    stop("No response column found (need prop_raw or Proportion).")
  }
  
  # --- Generate new data grid across observed elevation range for each site
  newdat <- data %>%
    dplyr::select(all_of(c(site_col, elev_col))) %>%
    distinct() %>%
    group_by(.data[[site_col]]) %>%
    summarize(
      elev_min = min(.data[[elev_col]], na.rm = TRUE),
      elev_max = max(.data[[elev_col]], na.rm = TRUE),
      .groups = "drop"
    ) %>%
    rowwise() %>%
    mutate(elev_seq = list(seq(elev_min, elev_max, length.out = 100))) %>%
    unnest(elev_seq) %>%
    rename(!!elev_col := elev_seq) %>%
    dplyr::select(all_of(c(site_col, elev_col))) %>%
    ungroup()
  
  # Ensure factor levels match model
  if (!is.null(model$xlevels$mean[[site_col]])) {
    newdat[[site_col]] <- factor(newdat[[site_col]],
                                 levels = model$xlevels$mean[[site_col]])
  } else {
    newdat[[site_col]] <- factor(newdat[[site_col]])
  }
  
  # --- Build design matrix (mean submodel only, no response)
  mean_terms <- stats::delete.response(stats::terms(model, model = "mean"))
  X <- model.matrix(mean_terms, newdat)
  
  beta <- coef(model, model = "mean")
  V <- try(vcov(model, model = "mean"), silent = TRUE)
  if (inherits(V, "try-error")) V <- vcov(model)
  
  # Predict link-scale and transform to response with 95% CI
  eta <- as.vector(X %*% beta)
  se_eta <- sqrt(rowSums((X %*% V) * X))
  newdat$fit <- inv_logit(eta)
  newdat$lwr <- inv_logit(eta - 1.96 * se_eta)
  newdat$upr <- inv_logit(eta + 1.96 * se_eta)
  
  # --- Plot raw data + model fit + CI ribbon
  ggplot() +
    geom_point(
      data = data,
      aes(x = .data[[elev_col]], y = .data[[prop_col]], colour = .data[[site_col]]),
      size = 2, alpha = 0.7, na.rm = TRUE
    ) +
    geom_ribbon(
      data = newdat,
      mapping = aes(x = .data[[elev_col]],
                    ymin = lwr, ymax = upr,
                    fill = .data[[site_col]],
                    group = .data[[site_col]]),
      alpha = 0.15, colour = NA,
      inherit.aes = FALSE
    ) +
    geom_line(
      data = newdat,
      mapping = aes(x = .data[[elev_col]],
                    y = fit,
                    colour = .data[[site_col]],
                    group = .data[[site_col]]),
      linewidth = 0.8,
      inherit.aes = FALSE
    ) +
    scale_y_continuous("Proportion (raw)", limits = c(0, 1)) +
    scale_x_continuous("Elevation (m)") +
    ggtitle(paste0(label_prefix, " – beta regression fit with raw data")) +
    theme_bw(base_size = 10) +
    theme(
      legend.position = "right",
      plot.title = element_text(face = "bold", size = 12, hjust = 0)
    )
}

p_helot <- plot_betareg_with_raw(model_helotiales, df, "Helotiales")
p_seba  <- plot_betareg_with_raw(model_sebacinales, df, "Sebacinales")

ggsave("/data/lastexpansion/danieang/Plots2/Helotiales_beta_with_raw.png",
       plot = p_helot, width = 7.2, height = 5.2, dpi = 600)
ggsave("/data/lastexpansion/danieang/Plots2/Sebacinales_beta_with_raw.png",
       plot = p_seba, width = 7.2, height = 5.2, dpi = 600)

###Making panel plot

p_helot_labeled <- p_helot +
  ggtitle("A) Helotiales") +
  theme(
    plot.title = element_text(face = "bold", size = 13, hjust = 0),
    # don't fix legend here; let patchwork handle it
    plot.margin = margin(5, 5, 5, 5)
  ) +
  annotate("text",
               x = Inf, y = 0.95,              # position near top-right; use -Inf for top-left
               hjust = 1.1, vjust = 1,
               label = "+10.6% / 100 m, p = 0.045",
               size = 3.1, fontface = "italic") 

p_seba_labeled <- p_seba +
  ggtitle("B) Sebacinales") +
  theme(
    plot.title = element_text(face = "bold", size = 13, hjust = 0),
    plot.margin = margin(5, 5, 5, 5)
  ) +
   annotate("text",
               x = Inf, y = 0.95,
               hjust = 1.1, vjust = 1,
               label = "−9.5% / 100 m, p = 0.096",
               size = 3.1, fontface = "italic") +
  theme(plot.margin = margin(5, 5, 5, 5))

# Combine side-by-side (horizontal layout)
panel_beta <- (p_helot_labeled | p_seba_labeled) +
  plot_layout(guides = "collect") &
  theme(
    legend.position       = "bottom",
    legend.title          = element_text(size = 9, face = "bold"),
    legend.text           = element_text(size = 8),
    legend.justification  = "center",
    legend.box.just       = "center"
  )

ggsave(
  "/data/lastexpansion/danieang/Plots2/Beta_regression_panel.png",
  plot = panel_beta,
  width = 12, height = 5.5, dpi = 900
)

#
p_helot_labeled <- p_helot +
  ggtitle("A) Helotiales") +
  theme(
    plot.title = element_text(face = "bold", size = 11, hjust = 0),
    legend.position = "bottom"
  )

p_seba_labeled <- p_seba +
  ggtitle("B) Sebacinales") +
  theme(
    plot.title = element_text(face = "bold", size = 11, hjust = 0),
    legend.position = "bottom"
  )

# Combine and collect a SINGLE legend
panel_beta <- (p_helot_labeled | p_seba_labeled) +
  plot_layout(guides = "collect") &
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 9, face = "bold"),
    legend.text  = element_text(size = 8),
    legend.justification = "center",
    legend.box.just = "center"  # centers the merged legend block
  )

# Optional: enforce centered layout for the collected legend
panel_beta <- panel_beta + plot_annotation() &
  theme(legend.position = "bottom",
        legend.justification = "center",
        legend.box.just = "center")

# Save high-res output
ggsave(
  "/data/lastexpansion/danieang/Plots2/Beta_regression_panel.png",
  plot = panel_beta,
  width = 12, height = 5.5, dpi = 800
)






